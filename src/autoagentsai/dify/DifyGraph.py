# src/autoagentsai/dify/DifyGraph.py
import yaml
from typing import Optional, Dict, Any, List, Union
from copy import deepcopy

from .DifyNodeRegistry import DIFY_NODE_TEMPLATES
from .DifyTypes import (
    DifyConfig, DifyApp, DifyWorkflow, DifyGraphModel,
    DifyNode, DifyEdge, Position, Viewport, EdgeData,
    create_node_data, WorkflowFeatures, FileUpload
)


class DifyGraph:
    """
    Difyå·¥ä½œæµå›¾æ„å»ºå™¨
    
    ç”¨äºæ„å»ºDifyå·¥ä½œæµé…ç½®çš„ä¸»è¦ç±»ï¼Œæä¾›ç±»ä¼¼FlowGraphçš„APIæ¥å£
    """
    
    def __init__(self, 
                 app_name: str = "AutoAgents Dify App",
                 app_description: str = "Generated by AutoAgents",
                 app_icon: str = "ğŸ¤–",
                 app_icon_background: str = "#FFEAD5"):
        """
        åˆå§‹åŒ–DifyGraph
        
        Args:
            app_name: åº”ç”¨åç§°
            app_description: åº”ç”¨æè¿°
            app_icon: åº”ç”¨å›¾æ ‡
            app_icon_background: å›¾æ ‡èƒŒæ™¯è‰²
        """
        self.config = DifyConfig(
            app=DifyApp(
                name=app_name,
                description=app_description,
                icon=app_icon,
                icon_background=app_icon_background
            ),
            workflow=DifyWorkflow(
                graph=DifyGraphModel()
            )
        )
        
        self.nodes: Dict[str, DifyNode] = {}
        self.edges: List[DifyEdge] = []
        self._node_counter = 1
        
        # ç‰¹æ®ŠèŠ‚ç‚¹æ ‡è¯†
        self.START = "start"
        self.END = "end"
        
    def _generate_node_id(self) -> str:
        """ç”Ÿæˆå”¯ä¸€çš„èŠ‚ç‚¹ID"""
        node_id = str(self._node_counter * 1000000000000 + 71169250)
        self._node_counter += 1
        return node_id
        
    def _generate_edge_id(self, source: str, target: str) -> str:
        """ç”Ÿæˆè¾¹çš„ID"""
        return f"{source}-source-{target}-target"
        
    def set_app_config(self, 
                      name: Optional[str] = None,
                      description: Optional[str] = None,
                      icon: Optional[str] = None,
                      icon_background: Optional[str] = None,
                      use_icon_as_answer_icon: Optional[bool] = None):
        """
        è®¾ç½®åº”ç”¨é…ç½®
        
        Args:
            name: åº”ç”¨åç§°
            description: åº”ç”¨æè¿°
            icon: åº”ç”¨å›¾æ ‡
            icon_background: å›¾æ ‡èƒŒæ™¯è‰²
            use_icon_as_answer_icon: æ˜¯å¦ä½¿ç”¨å›¾æ ‡ä½œä¸ºå›ç­”å›¾æ ‡
        """
        if name is not None:
            self.config.app.name = name
        if description is not None:
            self.config.app.description = description
        if icon is not None:
            self.config.app.icon = icon
        if icon_background is not None:
            self.config.app.icon_background = icon_background
        if use_icon_as_answer_icon is not None:
            self.config.app.use_icon_as_answer_icon = use_icon_as_answer_icon
            
    def set_workflow_features(self,
                             opening_statement: Optional[str] = None,
                             enable_file_upload: Optional[bool] = None,
                             file_upload_config: Optional[Dict[str, Any]] = None,
                             enable_speech_to_text: Optional[bool] = None,
                             enable_text_to_speech: Optional[bool] = None,
                             suggested_questions: Optional[List[str]] = None):
        """
        è®¾ç½®å·¥ä½œæµåŠŸèƒ½é…ç½®
        
        Args:
            opening_statement: å¼€åœºç™½
            enable_file_upload: æ˜¯å¦å¯ç”¨æ–‡ä»¶ä¸Šä¼ 
            file_upload_config: æ–‡ä»¶ä¸Šä¼ é…ç½®
            enable_speech_to_text: æ˜¯å¦å¯ç”¨è¯­éŸ³è½¬æ–‡å­—
            enable_text_to_speech: æ˜¯å¦å¯ç”¨æ–‡å­—è½¬è¯­éŸ³
            suggested_questions: å»ºè®®é—®é¢˜åˆ—è¡¨
        """
        if self.config.workflow.features is None:
            self.config.workflow.features = WorkflowFeatures()
            
        if opening_statement is not None:
            self.config.workflow.features.opening_statement = opening_statement
            
        if enable_file_upload is not None:
            if self.config.workflow.features.file_upload is None:
                self.config.workflow.features.file_upload = FileUpload()
            self.config.workflow.features.file_upload.enabled = enable_file_upload
            
        if file_upload_config is not None and self.config.workflow.features.file_upload is not None:
            # æ›´æ–°æ–‡ä»¶ä¸Šä¼ é…ç½®
            for key, value in file_upload_config.items():
                if hasattr(self.config.workflow.features.file_upload, key):
                    setattr(self.config.workflow.features.file_upload, key, value)
                    
        if enable_speech_to_text is not None:
            self.config.workflow.features.speech_to_text = {"enabled": enable_speech_to_text}
            
        if enable_text_to_speech is not None:
            self.config.workflow.features.text_to_speech = {"enabled": enable_text_to_speech, "language": "", "voice": ""}
            
        if suggested_questions is not None:
            self.config.workflow.features.suggested_questions = suggested_questions
    
    def add_node(self, 
                 node_id: Optional[str] = None,
                 node_type: str = "llm",
                 position: Optional[Dict[str, float]] = None,
                 title: Optional[str] = None,
                 **kwargs) -> str:
        """
        æ·»åŠ èŠ‚ç‚¹
        
        Args:
            node_id: èŠ‚ç‚¹IDï¼Œå¦‚æœä¸æä¾›åˆ™è‡ªåŠ¨ç”Ÿæˆ
            node_type: èŠ‚ç‚¹ç±»å‹
            position: èŠ‚ç‚¹ä½ç½® {"x": 100, "y": 200}
            title: èŠ‚ç‚¹æ ‡é¢˜
            **kwargs: èŠ‚ç‚¹ç‰¹å®šçš„é…ç½®å‚æ•°
            
        Returns:
            èŠ‚ç‚¹ID
        """
        if node_id is None:
            node_id = self._generate_node_id()
            
        if node_type not in DIFY_NODE_TEMPLATES:
            raise ValueError(f"Unsupported node type: {node_type}")
            
        template = deepcopy(DIFY_NODE_TEMPLATES[node_type])
        
        # è®¾ç½®ä½ç½®
        if position is None:
            position = {"x": len(self.nodes) * 300 + 30, "y": 227}
            
        node_position = Position(x=position["x"], y=position["y"])
        
        # åˆ›å»ºèŠ‚ç‚¹æ•°æ®
        node_data_kwargs = deepcopy(template["data"])
        if title:
            node_data_kwargs["title"] = title
            
        # åˆå¹¶ç”¨æˆ·æä¾›çš„å‚æ•°
        node_data_kwargs.update(kwargs)
        
        # åˆ›å»ºèŠ‚ç‚¹æ•°æ®
        node_data = create_node_data(node_type, **node_data_kwargs)
        
        # åˆ›å»ºèŠ‚ç‚¹
        node = DifyNode(
            id=node_id,
            data=node_data,
            position=node_position,
            positionAbsolute=node_position,
            width=template.get("width", 244),
            height=template.get("height", 54),
            sourcePosition=template.get("sourcePosition", "right"),
            targetPosition=template.get("targetPosition", "left")
        )
        
        self.nodes[node_id] = node
        return node_id
        
    def add_start_node(self, 
                      node_id: Optional[str] = None,
                      position: Optional[Dict[str, float]] = None,
                      variables: Optional[List[str]] = None) -> str:
        """æ·»åŠ å¼€å§‹èŠ‚ç‚¹"""
        if node_id is None:
            node_id = self.START
        return self.add_node(
            node_id=node_id,
            node_type="start", 
            position=position,
            variables=variables or []
        )
        
    def add_end_node(self,
                    node_id: Optional[str] = None, 
                    position: Optional[Dict[str, float]] = None,
                    outputs: Optional[List[str]] = None) -> str:
        """æ·»åŠ ç»“æŸèŠ‚ç‚¹"""
        if node_id is None:
            node_id = self.END
        return self.add_node(
            node_id=node_id,
            node_type="end",
            position=position,
            outputs=outputs or []
        )
        
    def add_llm_node(self,
                    node_id: Optional[str] = None,
                    position: Optional[Dict[str, float]] = None,
                    title: str = "LLM",
                    model_provider: str = "",
                    model_name: str = "",
                    temperature: float = 0.7,
                    system_prompt: str = "",
                    **kwargs) -> str:
        """æ·»åŠ LLMèŠ‚ç‚¹"""
        return self.add_node(
            node_id=node_id,
            node_type="llm",
            position=position,
            title=title,
            model={
                "mode": "chat",
                "provider": model_provider,
                "name": model_name,
                "completion_params": {"temperature": temperature}
            },
            prompt_template=[{"role": "system", "text": system_prompt}],
            **kwargs
        )
        
    def add_knowledge_retrieval_node(self,
                                   node_id: Optional[str] = None,
                                   position: Optional[Dict[str, float]] = None,
                                   title: str = "çŸ¥è¯†æ£€ç´¢",
                                   dataset_ids: Optional[List[str]] = None,
                                   top_k: int = 4,
                                   enable_reranking: bool = False,
                                   **kwargs) -> str:
        """æ·»åŠ çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹"""
        return self.add_node(
            node_id=node_id,
            node_type="knowledge-retrieval",
            position=position,
            title=title,
            dataset_ids=dataset_ids or [],
            multiple_retrieval_config={
                "top_k": top_k,
                "reranking_enable": enable_reranking
            },
            **kwargs
        )
        
    def add_edge(self, 
                source: str, 
                target: str,
                source_handle: str = "source",
                target_handle: str = "target") -> str:
        """
        æ·»åŠ è¾¹è¿æ¥ä¸¤ä¸ªèŠ‚ç‚¹
        
        Args:
            source: æºèŠ‚ç‚¹ID
            target: ç›®æ ‡èŠ‚ç‚¹ID  
            source_handle: æºå¥æŸ„
            target_handle: ç›®æ ‡å¥æŸ„
            
        Returns:
            è¾¹ID
        """
        if source not in self.nodes:
            raise ValueError(f"Source node {source} not found")
        if target not in self.nodes:
            raise ValueError(f"Target node {target} not found")
            
        edge_id = self._generate_edge_id(source, target)
        
        # è·å–èŠ‚ç‚¹ç±»å‹
        source_type = self.nodes[source].data.type
        target_type = self.nodes[target].data.type
        
        edge = DifyEdge(
            id=edge_id,
            source=source,
            target=target,
            sourceHandle=source_handle,
            targetHandle=target_handle,
            data=EdgeData(
                sourceType=source_type,
                targetType=target_type,
                isInLoop=False
            )
        )
        
        self.edges.append(edge)
        return edge_id
        
    def set_viewport(self, x: float, y: float, zoom: float):
        """è®¾ç½®è§†å£é…ç½®"""
        if self.config.workflow.graph is None:
            self.config.workflow.graph = DifyGraphModel()
        self.config.workflow.graph.viewport = Viewport(x=x, y=y, zoom=zoom)
        
    def to_dict(self) -> Dict[str, Any]:
        """å¯¼å‡ºä¸ºå­—å…¸æ ¼å¼"""
        # æ›´æ–°å›¾é…ç½®
        if self.config.workflow.graph is None:
            self.config.workflow.graph = DifyGraphModel()
            
        self.config.workflow.graph.nodes = list(self.nodes.values())
        self.config.workflow.graph.edges = self.edges
        
        return self.config.model_dump(exclude_none=True)
        
    def to_yaml(self) -> str:
        """å¯¼å‡ºä¸ºYAMLæ ¼å¼"""
        config_dict = self.to_dict()
        return yaml.dump(config_dict, default_flow_style=False, allow_unicode=True, sort_keys=False)
        
    def save_yaml(self, file_path: str):
        """ä¿å­˜ä¸ºYAMLæ–‡ä»¶"""
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(self.to_yaml())
            
    @classmethod
    def from_yaml(cls, file_path: str) -> 'DifyGraph':
        """ä»YAMLæ–‡ä»¶åŠ è½½é…ç½®"""
        with open(file_path, 'r', encoding='utf-8') as f:
            config_dict = yaml.safe_load(f)
            
        # åˆ›å»ºæ–°çš„DifyGraphå®ä¾‹
        graph = cls()
        graph.config = DifyConfig(**config_dict)
        
        # è§£æèŠ‚ç‚¹å’Œè¾¹
        if graph.config.workflow and graph.config.workflow.graph:
            if graph.config.workflow.graph.nodes:
                for node in graph.config.workflow.graph.nodes:
                    graph.nodes[node.id] = node
                    
            if graph.config.workflow.graph.edges:
                graph.edges = graph.config.workflow.graph.edges
                
        return graph
